<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="Images/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusBuzz</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">

</head>
<body>

    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div></div>
      </div>

<!-- Navbar -->
<header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">CampusBuzz</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto"> <!-- Changed to ml-auto to push navbar elements to the right -->
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="facilities.html">Facilities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reviews.html">Reviews</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about_us.html">About Us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-toggle="modal" id="logbutton" data-target="#loginModal">Login</a>
                    </li>
                </ul>
                <!-- Search bar -->
                <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>
</header>

<!-- Home Section -->
<section id="home">
    <div class="container">
        <h1>Welcome to CampusBuzz</h1>
        <p>Your premier destination for all things campus-related! Dive into a vibrant community where students share stories, reviews, and insider tips. Stay in the loop with trending topics, campus events, and exclusive deals. Join CampusBuzz today and discover the pulse of campus life like never before!</p>
        <!-- Call-to-action button --> <br>
        <a href="home.html#popular-reviews" class="btn btn btn-primary btn-custom">Featured Reviews</a>
        <a href="facilities.html" class="btn btn btn-primary btn-custom">Write a Review</a>
    </div>
</section>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Login to CampusBuzz</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <!-- Avatar image for login form -->
                    <div class="avatar-container">
                        <img src="Images/img_avatar2.png" alt="Avatar">
                    </div>
                    <form method="post" action="/login">
                        <div class="form-group">
                            <input type="email" class="form-control" id="email" name="email" required>
                            <label class="form-control-placeholder" for="email">Email</label>
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <label class="form-control-placeholder" for="password">Password</label>
                        </div>
                        <button type="submit" class="btn btn-login btn-block">Login</button>
                    </form>
                    <p class="text-center mt-3 signup-login-text">Don't have an account? <a href="#" id="signupLink">Sign up here</a></p>
                </div>
                <div id="signupForm" style="display: none;">
                    <!-- Avatar image for signup form -->
                    <div class="avatar-container">
                        <img src="Images/img_avatar2.png" alt="Avatar">
                    </div>
                    <form method="post" action="/signup">
                        <!-- Add signup form fields here -->
                        <div class="form-group">
                            <input type="text" class="form-control" id="username" name="username" required>
                            <label class="form-control-placeholder" for="username">Username</label>
                        </div>
                        <div class="form-group">
                            <input type="email" class="form-control" id="signupEmail" name="email" required>
                            <label class="form-control-placeholder" for="signupEmail">Email</label>
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="signupPassword" name="password" required>
                            <label class="form-control-placeholder" for="signupPassword">Password</label>
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <label class="form-control-placeholder" for="confirmPassword">Confirm Password</label>
                        </div>
                        <button type="submit" class="btn btn-login btn-block">Sign Up</button>
                    </form>
                    <p class="text-center mt-3 signup-login-text">Already have an account? <a href="#" id="loginLink">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Login Success Modal -->
<div class="modal fade" id="loginSuccessModal" tabindex="-1" role="dialog" aria-labelledby="loginSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginSuccessModalLabel">Login Successful</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Success message for login -->
                <p style="color: black;">You have successfully logged in.</p>
            </div>
        </div>
    </div>
</div>

<!-- Login Error Modal -->
<div class="modal fade" id="loginErrorModal" tabindex="-1" role="dialog" aria-labelledby="loginErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginErrorModalLabel">Login Failed</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Error message for login -->
                <p style="color: black;">Login failed. Please check your email and password and try again.</p>
            </div>
        </div>
    </div>
</div>

<!-- Signup Success Modal -->
<div class="modal fade" id="signupSuccessModal" tabindex="-1" role="dialog" aria-labelledby="signupSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signupSuccessModalLabel">Signup Successful</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Success message for signup -->
                <p style="color: black;">You have successfully signed up.</p>
            </div>
        </div>
    </div>
</div>

<!-- Signup Error Modal -->
<div class="modal fade" id="signupErrorModal" tabindex="-1" role="dialog" aria-labelledby="signupErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signupErrorModalLabel">Signup Failed</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Error message for signup -->
                <p id="errortext" style="color: black;">Signup failed. Please try again later.</p>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="container">
        <p>&copy; 2024 CampusBuzz. All rights reserved.</p>
    </div>
</footer>

<!-- Bootstrap JS (optional) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Script to toggle between login and signup forms -->
<script>
    $(document).ready(function() {
        $("#signupLink").click(function() {
            $("#loginForm").hide();
            $("#signupForm").show();
            $("#loginModalLabel").text("Sign Up to CampusBuzz");
        });

        $("#loginLink").click(function() {
            $("#signupForm").hide();
            $("#loginForm").show();
            $("#loginModalLabel").text("Login to CampusBuzz");
        });

        // Handle Login Form Submission
        $("#loginForm").submit(function(event) {
            event.preventDefault();
            var formData = {
                email: $("#email").val(),
                password: $("#password").val()
            };

            $.ajax({
                url: "/login",
                type: "POST",
                data: formData,
                xhrFields: {
                    withCredentials: true // Ensure cookies are sent with the request
                },
                crossDomain: true, // Necessary for cross-site requests
                success: function(response) {
                    console.log('Success:', response); // Debug success response
                    $("#logbutton").text('Logout').removeAttr('data-target');
                    $("#loginSuccessModal").modal("show");
                    setTimeout(() => {
                        $("#loginSuccessModal").modal("hide");
                        $("#loginModal").modal("hide");
                    }, 5000);
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error); // Debug error response
                    $("#loginErrorModal").modal("show");
                    setTimeout(() => $("#loginErrorModal").modal("hide"), 5000);
                }
            });
        });

        // Handle Logout
        $("#logbutton").click(function(event) {
            if ($(this).text() === 'Logout') {
                event.preventDefault();
                $.ajax({
                    url: "/logout",
                    type: "POST",
                    xhrFields: {
                        withCredentials: true // Ensure cookies are sent with the request
                    },
                    crossDomain: true, // Necessary for cross-site requests
                    success: function() {
                        $("#logbutton").text('Login').attr('data-target', '#loginModal');
                        window.location.href = '/home.html';
                    },
                    error: function() {
                        alert("Failed to log out. Please try again.");
                    }
                });
            }
        });

        // Handle Signup Form Submission
        $("#signupForm").submit(function(event) {
            event.preventDefault();
            var formData = {
                username: $("#username").val(),
                email: $("#signupEmail").val(),
                password: $("#signupPassword").val(),
                confirmPassword: $("#confirmPassword").val()
            };

            var password = $("#signupPassword").val();
            var confirmPassword = $("#confirmPassword").val();
            var passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/;

            if (!passwordRegex.test(password)) {
                $("#signupErrorModal").modal("show");
                $("#errortext").text("Password must be 8 characters long and contain uppercase, lowercase, digit, and special character.");
                return;
            }

            if (password !== confirmPassword) {
                $("#signupErrorModal").modal("show");
                $("#errortext").text("Passwords do not match");
                return;
            }

            $.ajax({
                url: "/signup",
                type: "POST",
                data: formData,
                xhrFields: {
                    withCredentials: true // Ensure cookies are sent with the request
                },
                crossDomain: true, // Necessary for cross-site requests
                success: function() {
                    $("#logbutton").text('Logout').removeAttr('data-target');
                    $("#signupSuccessModal").modal("show");
                    setTimeout(() => {
                        $("#signupSuccessModal").modal("hide");
                        $("#loginModal").modal("hide");
                    }, 5000);
                },
                error: function() {
                    $("#signupErrorModal").modal("show");
                    $("#errortext").text("Email already exists! Please select a different email.");
                    setTimeout(() => $("#signupErrorModal").modal("hide"), 5000);
                }
            });
        });

        // Hide Forms When Modal is Closed
        $('#loginModal').on('hidden.bs.modal', function () {
            $("#signupForm").hide();
            $("#loginForm").show();
            $("#loginModalLabel").text("Login to CampusBuzz");
        });

        // Check if user is logged in
        function checkUserLoggedIn() {
            $.ajax({
                url: "/check-token",
                type: "GET",
                xhrFields: {
                    withCredentials: true // Ensure cookies are sent with the request
                },
                crossDomain: true, // Necessary for cross-site requests
                success: function() {
                    $("#logbutton").text('Logout').removeAttr('data-target');
                },
                error: function() {
                    $("#logbutton").text('Login').attr('data-target', '#loginModal');
                }
            });
        }

        // Call checkUserLoggedIn on page load
        checkUserLoggedIn();

        // Check token status every 30 seconds
        setInterval(checkUserLoggedIn, 5000);
    });
</script>

<script>
    // Show spinner initially
    function showSpinner() {
      document.getElementById('loadingSpinner').style.display = 'flex';
    }

    // Hide spinner and show main content
    function hideSpinner() {
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    // Simulate loading delay
    window.addEventListener('load', function () {
      setTimeout(hideSpinner, 1000); // Replace with real loading logic
    });
</script>

</body>
</html>
